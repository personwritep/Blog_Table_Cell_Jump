// ==UserScript==
// @name        Blog Table â­ Cell Jump
// @namespace        http://tampermonkey.net/
// @version        0.2
// @description        ã€Œâ‡§ã€ã€Œâ‡©ã€ã‚­ãƒ¼ã§ã€Œtableã€å†…ã®ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã®ã‚»ãƒ«ç§»å‹•ã‚’å¯èƒ½ã«ã™ã‚‹
// @author        Ameba Blog User
// @match        https://blog.ameba.jp/ucs/entry/srventry*
// @exclude        https://blog.ameba.jp/ucs/entry/srventrylist.do*
// @icon        https://www.google.com/s2/favicons?sz=64&domain=ameblo.jp
// @grant        none
// @updateURL        https://github.com/personwritep/Blog_Table_Cell_Jump/raw/main/Blog_Table_Cell_Jump.user.js
// @downloadURL        https://github.com/personwritep/Blog_Table_Cell_Jump/raw/main/Blog_Table_Cell_Jump.user.js
// ==/UserScript==


let target=document.getElementById('cke_1_contents'); // ç›£è¦– target
let monitor=new MutationObserver( catch_key );
monitor.observe(target, {childList: true, attributes: true}); // ã‚­ãƒ¼æ“ä½œå¾…å—ã‘é–‹å§‹

catch_key();

function catch_key(){
    if(document.querySelector('.cke_wysiwyg_frame')!=null){ //ã€Œé€šå¸¸è¡¨ç¤ºã€ã‹ã‚‰å®Ÿè¡Œé–‹å§‹
        let editor_iframe=document.querySelector('.cke_wysiwyg_frame');
        let iframe_doc=editor_iframe.contentWindow.document;


        iframe_doc.addEventListener('keydown', function(event){
            if(!(event.ctrlKey || event.shiftKey || event.altKey || event.metaKey)){
                let table=is_table();
                if(table){
                    if(event.keyCode==38){
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        go(table, 0); }
                    if(event.keyCode==40){
                        event.preventDefault();
                        event.stopImmediatePropagation();
                        go(table, 1); }}}});


        function is_table(){
            let selection=iframe_doc.getSelection();
            if(selection.rangeCount>0){
                let range=selection.getRangeAt(0);
                let ac_node=selection.anchorNode;
                if(ac_node){
                    let table_elm=ac_node.parentElement.closest('table[id*="ambt"]'); // ğŸŸ¥ğŸŸ¥
                    if(table_elm){
                        return table_elm; }}}}



        function go(table, n){
            let td_all=table.querySelectorAll('td');
            let col=table.querySelector('tr').querySelectorAll('td').length;

            let now_point=get_now_pos(table);

            let el;
            if(n==0){
                el=td_all[now_point - col]; }
            else{
                el=td_all[now_point + col]; }
            if(el){
                let selection=iframe_doc.getSelection();
                if(selection.rangeCount>0){
                    let range=selection.getRangeAt(0);
                    range.setStart(el, 1); // (el, 0) ï¼štdã®å…ˆé ­ã€€(el, 1) ï¼štdã®æœ«å°¾
                    range.collapse(true); }} // trueã§å…ˆé ­å´ã«é–‰ã˜ã‚‹å¿…è¦ã‚ã‚Š

        } // go(n)



        function get_now_pos(table){
            let point=get_td();
            if(point){
                let now_tdp;
                let now_trp;

                let tr_p=point.closest('tr');
                let tr_p_td=tr_p.querySelectorAll('td');
                for(let k=0; k<tr_p_td.length; k++){
                    if(tr_p_td[k]==point){
                        now_tdp=k; break; }}

                let tr_all=table.querySelectorAll('tr');
                for(let k=0; k<tr_all.length; k++){
                    if(tr_all[k]==tr_p){
                        now_trp=k; break; }}

                return tr_p_td.length*now_trp + now_tdp; }


            function get_td(){
                let selection=iframe_doc.getSelection();
                if(selection.rangeCount>0){
                    let point;
                    let range=selection.getRangeAt(0);
                    let container=range.startContainer;
                    if(container.nodeType==1){
                        point=container.closest('td'); }
                    else{
                        point=container.parentElement.closest('td'); }

                    return point; }}

        } // get_now_pos(table)

    }
} // catch_key()

